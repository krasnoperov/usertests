# ============================================================================
# UserTests - Main Worker Configuration
# ============================================================================
# Handles HTTP requests (API + Frontend)

account_id = "2d61278ad8b69df60cde602758926e14"
name = "usertests-stage"
main = "src/worker/unified.ts"
compatibility_date = "2025-04-01"
compatibility_flags = ["nodejs_compat"]

[observability]
enabled = true

[assets]
directory = "./dist/frontend"
not_found_handling = "single-page-application"
run_worker_first = ["/api/*", "/.well-known/*"]

# Stage custom domain
[[routes]]
pattern = "usertests-stage.krasnoperov.me"
custom_domain = true

# D1 Database
[[d1_databases]]
binding = "DB"
database_name = "usertests-stage"
database_id = "e8ac02de-bf4b-49f2-9a73-ed45c1810abc"
migrations_dir = "db/migrations"

# KV namespace for OAuth state
[[kv_namespaces]]
binding = "OAUTH_KV"
id = "08f7fd3b25ac4cc59ad9e2975d510df3"

# R2 Storage (audio, recordings, exports)
[[r2_buckets]]
binding = "STORAGE"
bucket_name = "usertests-storage-stage"

# Queue Producer
[[queues.producers]]
queue = "usertests-processing-stage"
binding = "PROCESSING_QUEUE"

[vars]
NODE_ENV = "stage"
ENVIRONMENT = "stage"

# ====================
# PRODUCTION
# ====================
[env.production]
name = "usertests-production"

[[env.production.routes]]
pattern = "usertests.krasnoperov.me"
custom_domain = true

[[env.production.d1_databases]]
binding = "DB"
database_name = "usertests-production"
database_id = "5a755b7e-9e9e-498c-b656-0cc588152f15"
migrations_dir = "db/migrations"

[[env.production.kv_namespaces]]
binding = "OAUTH_KV"
id = "08f7fd3b25ac4cc59ad9e2975d510df3"

# TODO: Create production R2 bucket and queue
# [[env.production.r2_buckets]]
# binding = "STORAGE"
# bucket_name = "usertests-storage-production"

# [[env.production.queues.producers]]
# queue = "usertests-processing-production"
# binding = "PROCESSING_QUEUE"

[env.production.vars]
NODE_ENV = "production"
ENVIRONMENT = "production"

# ====================
# LOCAL DEVELOPMENT
# ====================
[dev]
port = 8788
local_protocol = "http"
