<!DOCTYPE html>
<html>
<head>
    <title>Navigation Test</title>
    <style>
        body {
            font-family: monospace;
            padding: 20px;
            background: #1a1a1a;
            color: #fff;
        }
        .status {
            background: #333;
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
        }
        button, a {
            margin: 5px;
            padding: 8px 15px;
            background: #4a90e2;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            text-decoration: none;
            display: inline-block;
        }
        button:hover, a:hover {
            background: #357abd;
        }
        .log {
            background: #222;
            padding: 10px;
            margin-top: 20px;
            border-radius: 4px;
            max-height: 300px;
            overflow-y: auto;
        }
        .log-entry {
            margin: 2px 0;
            font-size: 12px;
        }
    </style>
</head>
<body>
    <h1>Navigation System Test</h1>

    <div class="status">
        <div>Current URL: <span id="currentUrl"></span></div>
        <div>Route Page: <span id="routePage"></span></div>
        <div>Route Params: <span id="routeParams"></span></div>
        <div>Navigation API: <span id="navApiSupport"></span></div>
    </div>

    <div>
        <h3>Test Navigation:</h3>
        <button onclick="testNavigate('/')">Home (/)</button>
        <button onclick="testNavigate('/login')">Login</button>
        <button onclick="testNavigate('/upload')">Upload</button>
        <button onclick="testNavigate('/profile')">Profile</button>
        <button onclick="testNavigate('/listen/episode-123')">Listen Episode</button>
        <button onclick="testNavigate('/speak/episode-456')">Speak Episode</button>
        <button onclick="testNavigate('/unknown/route')">Unknown Route</button>
    </div>

    <div>
        <h3>Test Replace:</h3>
        <button onclick="testNavigate('/login', true)">Replace with Login</button>
        <button onclick="testNavigate('/upload', true)">Replace with Upload</button>
    </div>

    <div>
        <h3>Browser Navigation:</h3>
        <button onclick="history.back()">Back</button>
        <button onclick="history.forward()">Forward</button>
    </div>

    <div class="log" id="log">
        <div>Event Log:</div>
    </div>

    <script type="module">
        // Import and test our navigation system
        import { initNavigator, subscribeToNavigation, navigate } from './navigator.js';
        import { useRouteStore } from '../stores/routeStore.js';

        const logElement = document.getElementById('log');
        const addLog = (message) => {
            const entry = document.createElement('div');
            entry.className = 'log-entry';
            entry.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
            logElement.appendChild(entry);
            logElement.scrollTop = logElement.scrollHeight;
        };

        // Check Navigation API support
        const hasNavApi = 'navigation' in window && typeof window.navigation?.addEventListener === 'function';
        document.getElementById('navApiSupport').textContent = hasNavApi ? 'YES (Modern)' : 'NO (Using History API fallback)';
        addLog(`Navigation API Support: ${hasNavApi ? 'YES' : 'NO (fallback)'}`);

        // Initialize navigation
        initNavigator();
        addLog('Navigator initialized');

        // Subscribe to navigation events
        subscribeToNavigation((url) => {
            addLog(`Navigation event: ${url.pathname}${url.search}`);
            updateStatus();
        });

        // Update status display
        const updateStatus = () => {
            const state = useRouteStore.getState();
            document.getElementById('currentUrl').textContent = window.location.pathname + window.location.search;
            document.getElementById('routePage').textContent = state.page;
            document.getElementById('routeParams').textContent = JSON.stringify(state.params);
        };

        // Make navigate function available globally for buttons
        window.testNavigate = (path, replace = false) => {
            addLog(`Navigating to: ${path} (replace: ${replace})`);
            navigate(path, { replace });
        };

        // Initial status
        updateStatus();
        addLog('Test page loaded');

        // Listen to store changes
        useRouteStore.subscribe(() => {
            const state = useRouteStore.getState();
            addLog(`Store updated: page=${state.page}, path=${state.path}`);
            updateStatus();
        });
    </script>
</body>
</html>