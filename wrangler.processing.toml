# ============================================================================
# UserTests - Processing Worker Configuration
# ============================================================================
# Handles queue consumption and workflows

account_id = "2d61278ad8b69df60cde602758926e14"
name = "usertests-processing-stage"
main = "src/worker/processing.ts"
compatibility_date = "2025-04-01"
compatibility_flags = ["nodejs_compat"]

[observability]
enabled = true

[[d1_databases]]
binding = "DB"
database_name = "usertests-stage"
database_id = "e8ac02de-bf4b-49f2-9a73-ed45c1810abc"
migrations_dir = "db/migrations"

[[kv_namespaces]]
binding = "OAUTH_KV"
id = "08f7fd3b25ac4cc59ad9e2975d510df3"

# Queue Consumer
[[queues.consumers]]
queue = "usertests-processing-stage"
max_batch_size = 1
max_batch_timeout = 60
max_retries = 3

# Queue Producer (for retries)
[[queues.producers]]
queue = "usertests-processing-stage"
binding = "PROCESSING_QUEUE"

# R2 Storage
[[r2_buckets]]
binding = "STORAGE"
bucket_name = "usertests-storage-stage"

[vars]
NODE_ENV = "stage"
ENVIRONMENT = "stage"

# ====================
# PRODUCTION
# ====================
[env.production]
name = "usertests-processing-production"

[[env.production.d1_databases]]
binding = "DB"
database_name = "usertests-production"
database_id = "5a755b7e-9e9e-498c-b656-0cc588152f15"
migrations_dir = "db/migrations"

[[env.production.kv_namespaces]]
binding = "OAUTH_KV"
id = "08f7fd3b25ac4cc59ad9e2975d510df3"

# D1: Queue Consumer (production)
[[env.production.queues.consumers]]
queue = "usertests-processing-production"
max_batch_size = 1
max_batch_timeout = 60
max_retries = 3

# D1: Queue Producer for retries (production)
[[env.production.queues.producers]]
queue = "usertests-processing-production"
binding = "PROCESSING_QUEUE"

# D1: R2 Storage (production)
[[env.production.r2_buckets]]
binding = "STORAGE"
bucket_name = "usertests-storage-production"

[env.production.vars]
NODE_ENV = "production"
ENVIRONMENT = "production"

[dev]
port = 8789
local_protocol = "http"
